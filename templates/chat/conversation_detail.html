{% extends 'base.html' %}
{% load static %}

{% block title %}{{ conversation.title }} - AkashChat{% endblock %}

{% block main_class %}container-fluid p-0{% endblock %}

{% block content %}
<div class="row g-0 vh-100">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 bg-light border-end">
        <div class="d-flex flex-column h-100">
            <!-- New Conversation Button -->
            <div class="p-3 border-bottom">
                <button class="btn btn-primary w-100" id="newConversationBtn">
                    <i class="bi bi-plus-circle me-2"></i>New Conversation
                </button>
            </div>

            <!-- Back to Conversations -->
            <div class="p-3 border-bottom">
                <a href="{% url 'chat:conversation_list' %}" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-arrow-left me-2"></i>All Conversations
                </a>
            </div>

            <!-- Current Conversation Info -->
            <div class="p-3 border-bottom">
                <h6 class="mb-2">Current Conversation</h6>
                <p class="mb-1 text-truncate" id="conversationTitle">{{ conversation.title }}</p>
                <small class="text-muted">{{ conversation.updated_at|timesince }} ago</small>
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-primary me-1" id="renameConversationBtn">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" id="deleteConversationBtn">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="col-md-9 col-lg-10">
        <div class="d-flex flex-column h-100">
            <!-- Chat Header -->
            <div class="bg-white border-bottom p-3">
                <h5 class="mb-0">{{ conversation.title }}</h5>
            </div>

            <!-- Messages Area -->
            <div class="flex-grow-1 overflow-auto p-3" id="messagesContainer">
                <div id="messagesList">
                    {% for message in messages %}
                    <div class="message-bubble {{ message.role }}-message mb-3" data-message-id="{{ message.id }}">
                        <div class="d-flex {% if message.role == 'user' %}justify-content-end{% endif %}">
                            <div class="message-content {% if message.role == 'user' %}bg-primary text-white{% else %}bg-light{% endif %} rounded-3 p-3 position-relative" style="max-width: 70%;">
                                <div class="message-text">{{ message.content|linebreaks }}</div>
                                <div class="message-meta d-flex justify-content-between align-items-center mt-2">
                                    <small class="{% if message.role == 'user' %}text-white-50{% else %}text-muted{% endif %}">
                                        {{ message.created_at|date:"M d, H:i" }}
                                        {% if message.edited %}
                                        <span class="badge bg-warning text-dark ms-1">Edited</span>
                                        {% endif %}
                                        {% if message.superseded %}
                                        <span class="badge bg-info ms-1">Regenerated</span>
                                        {% endif %}
                                    </small>
                                    {% if message.role == 'user' %}
                                    <div class="message-actions">
                                        <button class="btn btn-sm btn-outline-light edit-message-btn" data-message-id="{{ message.id }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        {% if message.assistant_replies.exists %}
                                        <button class="btn btn-sm btn-outline-light regenerate-btn" data-message-id="{{ message.id }}">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Typing Indicator -->
                <div id="typingIndicator" class="message-bubble assistant-message mb-3" style="display: none;">
                    <div class="d-flex">
                        <div class="bg-light rounded-3 p-3">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Input -->
            <div class="bg-white border-top p-3">
                <form id="messageForm" class="d-flex gap-2">
                    {% csrf_token %}
                    <div class="flex-grow-1">
                        <textarea class="form-control" id="messageInput" rows="1" 
                                  placeholder="Type your message..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" id="sendBtn">
                        <i class="bi bi-send"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Message Modal -->
<div class="modal fade" id="editMessageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editMessageForm">
                    <div class="mb-3">
                        <label for="editMessageContent" class="form-label">Message Content</label>
                        <textarea class="form-control" id="editMessageContent" rows="4" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEditBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Rename Conversation Modal -->
<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rename Conversation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="renameForm">
                    <div class="mb-3">
                        <label for="conversationTitleInput" class="form-label">Conversation Title</label>
                        <input type="text" class="form-control" id="conversationTitleInput" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveRenameBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Conversation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this conversation? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const conversationId = {{ conversation.id }};
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const messagesList = document.getElementById('messagesList');
    const messagesContainer = document.getElementById('messagesContainer');
    const typingIndicator = document.getElementById('typingIndicator');
    
    const editMessageModal = new bootstrap.Modal(document.getElementById('editMessageModal'));
    const renameModal = new bootstrap.Modal(document.getElementById('renameModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    
    let currentEditMessageId = null;

    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });

    // Send message on Enter (but allow Shift+Enter for new lines)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            messageForm.dispatchEvent(new Event('submit'));
        }
    });

    // Send message
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const content = messageInput.value.trim();
        if (!content) return;

        sendMessage(content);
    });

    function sendMessage(content) {
        // Disable input
        messageInput.disabled = true;
        sendBtn.disabled = true;
        
        // Show typing indicator
        typingIndicator.style.display = 'block';
        scrollToBottom();

        fetch(`/conversations/${conversationId}/messages/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
            if (data.user_message && data.assistant_message) {
                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                // Add messages to UI
                addMessageToUI(data.user_message, 'user');
                addMessageToUI(data.assistant_message, 'assistant');
            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error('Error sending message:', error);
            alert('Failed to send message');
        })
        .finally(() => {
            // Re-enable input
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();
            
            // Hide typing indicator
            typingIndicator.style.display = 'none';
        });
    }

    function addMessageToUI(message, role) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-bubble ${role}-message mb-3`;
        messageDiv.dataset.messageId = message.id;
        
        const isUser = role === 'user';
        const bgClass = isUser ? 'bg-primary text-white' : 'bg-light';
        const textClass = isUser ? 'text-white-50' : 'text-muted';
        
        messageDiv.innerHTML = `
            <div class="d-flex ${isUser ? 'justify-content-end' : ''}">
                <div class="message-content ${bgClass} rounded-3 p-3 position-relative" style="max-width: 70%;">
                    <div class="message-text">${message.content.replace(/\n/g, '<br>')}</div>
                    <div class="message-meta d-flex justify-content-between align-items-center mt-2">
                        <small class="${textClass}">
                            ${new Date(message.created_at).toLocaleString()}
                            ${message.edited ? '<span class="badge bg-warning text-dark ms-1">Edited</span>' : ''}
                            ${message.superseded ? '<span class="badge bg-info ms-1">Regenerated</span>' : ''}
                        </small>
                        ${isUser ? `
                        <div class="message-actions">
                            <button class="btn btn-sm btn-outline-light edit-message-btn" data-message-id="${message.id}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light regenerate-btn" data-message-id="${message.id}">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        
        messagesList.appendChild(messageDiv);
        scrollToBottom();
    }

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Edit message
    document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-message-btn')) {
            const messageId = e.target.closest('.edit-message-btn').dataset.messageId;
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            const messageText = messageElement.querySelector('.message-text').textContent;
            
            currentEditMessageId = messageId;
            document.getElementById('editMessageContent').value = messageText;
            editMessageModal.show();
        }
    });

    document.getElementById('saveEditBtn').addEventListener('click', function() {
        const newContent = document.getElementById('editMessageContent').value.trim();
        if (!newContent) {
            alert('Message content cannot be empty');
            return;
        }

        fetch(`/messages/${currentEditMessageId}/edit/`, {
            method: 'PATCH',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content: newContent })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update message in UI
                const messageElement = document.querySelector(`[data-message-id="${currentEditMessageId}"]`);
                const messageText = messageElement.querySelector('.message-text');
                const messageMeta = messageElement.querySelector('.message-meta small');
                
                messageText.innerHTML = newContent.replace(/\n/g, '<br>');
                
                // Add edited badge if not already present
                if (!messageMeta.innerHTML.includes('Edited')) {
                    messageMeta.innerHTML += ' <span class="badge bg-warning text-dark ms-1">Edited</span>';
                }
                
                editMessageModal.hide();
            } else {
                alert(data.error || 'Failed to edit message');
            }
        })
        .catch(error => {
            console.error('Error editing message:', error);
            alert('Failed to edit message');
        });
    });

    // Regenerate reply
    document.addEventListener('click', function(e) {
        if (e.target.closest('.regenerate-btn')) {
            const messageId = e.target.closest('.regenerate-btn').dataset.messageId;
            
            // Show typing indicator
            typingIndicator.style.display = 'block';
            scrollToBottom();

            fetch(`/conversations/${conversationId}/regenerate/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message_id: messageId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.assistant_message) {
                    // Find and remove the old assistant reply
                    const userMessage = document.querySelector(`[data-message-id="${messageId}"]`);
                    let nextElement = userMessage.nextElementSibling;
                    while (nextElement && nextElement.classList.contains('assistant-message')) {
                        const toRemove = nextElement;
                        nextElement = nextElement.nextElementSibling;
                        toRemove.remove();
                    }
                    
                    // Add new assistant message
                    addMessageToUI(data.assistant_message, 'assistant');
                } else {
                    alert(data.error || 'Failed to regenerate reply');
                }
            })
            .catch(error => {
                console.error('Error regenerating reply:', error);
                alert('Failed to regenerate reply');
            })
            .finally(() => {
                typingIndicator.style.display = 'none';
            });
        }
    });

    // Create new conversation
    document.getElementById('newConversationBtn').addEventListener('click', function() {
        fetch('/conversations/new/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                window.location.href = `/conversations/${data.id}/`;
            }
        })
        .catch(error => {
            console.error('Error creating conversation:', error);
            alert('Failed to create new conversation');
        });
    });

    // Rename conversation
    document.getElementById('renameConversationBtn').addEventListener('click', function() {
        const currentTitle = document.getElementById('conversationTitle').textContent;
        document.getElementById('conversationTitleInput').value = currentTitle;
        renameModal.show();
    });

    document.getElementById('saveRenameBtn').addEventListener('click', function() {
        const newTitle = document.getElementById('conversationTitleInput').value.trim();
        if (!newTitle) {
            alert('Title cannot be empty');
            return;
        }

        fetch(`/conversations/${conversationId}/rename/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ title: newTitle })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('conversationTitle').textContent = data.title;
                document.querySelector('.bg-white.border-bottom h5').textContent = data.title;
                renameModal.hide();
            } else {
                alert(data.error || 'Failed to rename conversation');
            }
        })
        .catch(error => {
            console.error('Error renaming conversation:', error);
            alert('Failed to rename conversation');
        });
    });

    // Delete conversation
    document.getElementById('deleteConversationBtn').addEventListener('click', function() {
        deleteModal.show();
    });

    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        fetch(`/conversations/${conversationId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/conversations/';
            } else {
                alert('Failed to delete conversation');
            }
        })
        .catch(error => {
            console.error('Error deleting conversation:', error);
            alert('Failed to delete conversation');
        });
    });

    // CSRF token helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Initial scroll to bottom
    scrollToBottom();
    
    // Focus on message input
    messageInput.focus();
});
</script>
{% endblock %}

